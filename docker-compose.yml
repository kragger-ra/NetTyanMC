version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: minecraft_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-minecraft_server}
      POSTGRES_USER: ${POSTGRES_USER:-mcserver}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-StrongPass123!}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - minecraft_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mcserver} -d ${POSTGRES_DB:-minecraft_server}"]
      interval: 10s
      timeout: 5s
      retries: 5

  velocity:
    build: ./velocity
    container_name: minecraft_velocity
    restart: unless-stopped
    ports:
      - "25565:25565"
      - "25577:25577/udp"
    volumes:
      - ./velocity:/server
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true

  survival:
    image: itzg/minecraft-server
    container_name: minecraft_survival
    restart: unless-stopped
    environment:
      TYPE: PAPER
      VERSION: 1.21.1
      MEMORY: ${SURVIVAL_MEMORY:-10G}
      EULA: "TRUE"
      ONLINE_MODE: "FALSE"
      SERVER_PORT: 25565
      USE_AIKAR_FLAGS: "TRUE"
      # Config sync settings
      SYNC_SKIP_NEWER_IN_DESTINATION: "true"
      COPY_CONFIG_DEST: /data
      REPLACE_ENV_DURING_SYNC: "true"
    ports:
      - "25571:25565"
    volumes:
      - survival_data:/data                    # Persistent data (JAR, worlds, userdata)
      - ./survival/config:/config:ro           # Configs from Git (read-only)
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles: ["debug"]

  airesearch:
    image: itzg/minecraft-server
    container_name: minecraft_airesearch
    restart: unless-stopped
    environment:
      TYPE: PAPER
      VERSION: 1.21.1
      COPY_PLUGINS_SRC: /plugins-common,/plugins-local
      MEMORY: ${AI_RESEARCH_MEMORY:-10G}
      EULA: "TRUE"
      ONLINE_MODE: "FALSE"
      SERVER_PORT: 25570
      USE_AIKAR_FLAGS: "TRUE"
      # Config sync settings
      SYNC_SKIP_NEWER_IN_DESTINATION: "true"
      COPY_CONFIG_DEST: /data
      REPLACE_ENV_DURING_SYNC: "true"
      WORLD: /worlds/world
    ports:
      - "24454:24454/udp"
    expose:
      - "25570"
    volumes:
      - ./ai_research/worlds:/worlds
      # For example, reference a shared directory used by several projects
      - ../plugins-common:/plugins-common:ro
      # and add plugins unique to this project
      - ./plugins:/plugins-local:ro
      # Configs from Git (read-only)
      - ./ai_research/config:/config:ro
      - airesearch_data:/data                  # Persistent data (userdata)
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true

  lobby:
    image: itzg/minecraft-server
    container_name: minecraft_lobby
    restart: unless-stopped
    environment:
      TYPE: PAPER
      VERSION: 1.21.1
      MEMORY: ${LOBBY_MEMORY:-2G}
      EULA: "TRUE"
      ONLINE_MODE: "FALSE"
      SERVER_PORT: 25565
      USE_AIKAR_FLAGS: "TRUE"
      # Config sync settings
      SYNC_SKIP_NEWER_IN_DESTINATION: "true"
      COPY_CONFIG_DEST: /data
      REPLACE_ENV_DURING_SYNC: "true"
    ports:
      - "25575:25565"
    volumes:
      - lobby_data:/data                       # Persistent data (JAR, worlds, userdata)
      - ./lobby/config:/config:ro              # Configs from Git (read-only)
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles: ["debug"]

  survivalplus:
    image: itzg/minecraft-server
    container_name: minecraft_survivalplus
    restart: unless-stopped
    environment:
      TYPE: PAPER
      VERSION: 1.21.1
      MEMORY: ${SURVIVALPLUS_MEMORY:-12G}
      EULA: "TRUE"
      ONLINE_MODE: "FALSE"
      SERVER_PORT: 25565
      USE_AIKAR_FLAGS: "TRUE"
      # Config sync settings
      SYNC_SKIP_NEWER_IN_DESTINATION: "true"
      COPY_CONFIG_DEST: /data
      REPLACE_ENV_DURING_SYNC: "true"
    ports:
      - "25573:25565"  # Direct access for Survival+
    volumes:
      - survivalplus_data:/data                # Persistent data (JAR, worlds, userdata)
      - ./survival_plus/config:/config:ro      # Configs from Git (read-only)
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles: ["debug"]

  backend:
    build: ./backend
    container_name: agicraft_backend
    restart: unless-stopped
    expose:
      - "3000"  # Internal port (accessible via Caddy)
    volumes:
      - ./backend/src:/app/src
    networks:
      - minecraft_network
      - nettyan_ssl
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-minecraft_server}
      POSTGRES_USER: ${POSTGRES_USER:-mcserver}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-StrongPass123!}
      JWT_SECRET: ${JWT_SECRET:-change_this_secret_key}
      PORT: 3000
      NODE_ENV: ${NODE_ENV:-production}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      YOOKASSA_RETURN_URL: ${YOOKASSA_RETURN_URL:-http://localhost/payment/success}
      YOOKASSA_WEBHOOK_URL: ${YOOKASSA_WEBHOOK_URL:-http://localhost/api/payment/webhook}
      MINECRAFT_HOST: airesearch
      MINECRAFT_PORT: 25570
      MINECRAFT_VERSION: 1.21.1
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build: ./frontend
    container_name: agicraft_frontend
    restart: unless-stopped
    expose:
      - "80"  # Internal port (accessible via nettyanweb Caddy)
    networks:
      - minecraft_network
      - nettyan_ssl
    depends_on:
      backend:
        condition: service_healthy
    environment:
      VITE_API_URL: ${VITE_API_URL:-/api}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ============================================
  # CRAFTY CONTROLLER - Web UI для управления серверами
  # ============================================
  # Опционально: Веб-панель управления Minecraft серверами
  # Доступ: https://localhost:8443 (по умолчанию admin/crafty)
  # Документация: https://craftycontrol.com/
  crafty:
    image: registry.gitlab.com/crafty-controller/crafty-4:latest
    container_name: crafty_controller
    restart: unless-stopped
    ports:
      - "8443:8443"   # HTTPS Web UI
      - "8123:8123"   # Websocket
    volumes:
      - crafty_data:/crafty/app/config
      - crafty_backups:/crafty/backups
      - crafty_logs:/crafty/logs
      - crafty_servers:/crafty/servers
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker socket для управления контейнерами
    networks:
      - minecraft_network
      - nettyan_ssl
    environment:
      TZ: ${TZ:-Europe/Moscow}
    # Комментируйте этот сервис если не нужен Crafty Controller
    # profiles: ["management"]  # Раскомментируйте чтобы запускать только с --profile management

networks:
  minecraft_network:
    driver: bridge
  nettyan_ssl:
    external: true
    name: nettyan_ssl

volumes:
  # PostgreSQL data
  postgres_data:
    name: nettyanmc_postgres_data

  # Minecraft server data volumes (persistent across rebuilds)
  # velocity_data removed - using custom build with local mount
  survival_data:
    name: nettyanmc_survival_data
  lobby_data:
    name: nettyanmc_lobby_data
  airesearch_data:
    name: nettyanmc_airesearch_data
  survivalplus_data:
    name: nettyanmc_survivalplus_data

  # Crafty Controller data (опционально)
  crafty_data:
    name: nettyanmc_crafty_data
  crafty_backups:
    name: nettyanmc_crafty_backups
  crafty_logs:
    name: nettyanmc_crafty_logs
  crafty_servers:
    name: nettyanmc_crafty_servers
