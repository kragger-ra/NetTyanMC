version: '3.8'

services:
  ## UTILITY SECTION
  ## MANDATORY POSTGRES DATABASE FOR SERVERS
  postgres:
    image: postgres:16-alpine
    container_name: minecraft_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-minecraft_server}
      POSTGRES_USER: ${POSTGRES_USER:-mcserver}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-StrongPass123!}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - minecraft_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mcserver} -d ${POSTGRES_DB:-minecraft_server}"]
      interval: 10s
      timeout: 5s
      retries: 5

  ## SERVER PROXY SECTION
  ## CONNECTION BETWEEN SERVERS
  velocity:
    build: ./velocity
    container_name: minecraft_velocity
    restart: unless-stopped
    ports:
      - "25565:25565"
      - "24454:24454/udp"
      - "25577:25577/udp"
    volumes:
      - ./velocity:/server
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true

## MAIN TARGET SERVER FOR NOW
  airesearch:
    image: itzg/minecraft-server
    container_name: minecraft_airesearch
    restart: unless-stopped
    environment:
      TYPE: PAPER
      VERSION: 1.21.1
      COPY_PLUGINS_SRC: /plugins-common,/plugins-local
      
      # Standart memory settings. DISABLE if using AIKAR setup
      MAX_MEMORY: 6G
      MIN_MEMORY: 1G
      JVM_OPTS: "-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled"
      
      # AIKAR SETUP for BIG servers and 10G+ RAM
      # but will get ALL memory in use and some plugins may have issues
      # MEMORY: ${AI_RESEARCH_MEMORY:-8G}
      # USE_AIKAR_FLAGS: "TRUE"
      
      EULA: "TRUE"
      ONLINE_MODE: "FALSE"
      SERVER_PORT: 25570
      RCON_PASSWORD: ${RCON_PASSWORD:-StrongPass123!}
      RCON_PORT: 25580
      ENABLE_RCON: "TRUE"
      # Config sync settings
      SYNC_SKIP_NEWER_IN_DESTINATION: "true"
      COPY_CONFIG_DEST: /data
      REPLACE_ENV_DURING_SYNC: "true"
      WORLD: /worlds/world
    ports:
      - "25610:25610"  # BlueMap webserver port
    expose:
      - "25570"  # Server port
      - "25580"  # RCON port
      - "24454/udp"  # VoiceChatPort
    volumes:
      - ./ai_research/data:/data
      - ./ai_research/worlds:/worlds
      # For example, reference a shared directory used by several projects
      - ./plugins-common:/plugins-common:ro
      # and add plugins unique to this project
      - ./ai_research/plugins:/plugins-local:ro
      # Configs from Git (read-only)
      - ./ai_research/config:/config:ro
    networks:
      - minecraft_network
      - nettyan_ssl
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true



## DISABLED NON-READY SERVERS SECTION
## TO RUN THEM, START CONTAINERS MANUALLY

  lobby:
    image: itzg/minecraft-server
    container_name: minecraft_lobby
    restart: unless-stopped
    environment:
      TYPE: PAPER
      VERSION: 1.21.1
      MEMORY: ${LOBBY_MEMORY:-2G}
      EULA: "TRUE"
      ONLINE_MODE: "FALSE"
      SERVER_PORT: 25565
      USE_AIKAR_FLAGS: "TRUE"
      # Config sync settings
      SYNC_SKIP_NEWER_IN_DESTINATION: "true"
      COPY_CONFIG_DEST: /data
      REPLACE_ENV_DURING_SYNC: "true"
    ports:
      - "25575:25565"
    volumes:
      - lobby_data:/data                       # Persistent data (JAR, worlds, userdata)
      - ./lobby/config:/config:ro              # Configs from Git (read-only)
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles: ["debug"]

  survivalplus:
    image: itzg/minecraft-server
    container_name: minecraft_survivalplus
    restart: unless-stopped
    environment:
      TYPE: PAPER
      VERSION: 1.21.1
      MEMORY: ${SURVIVALPLUS_MEMORY:-12G}
      EULA: "TRUE"
      ONLINE_MODE: "FALSE"
      SERVER_PORT: 25565
      USE_AIKAR_FLAGS: "TRUE"
      # Config sync settings
      SYNC_SKIP_NEWER_IN_DESTINATION: "true"
      COPY_CONFIG_DEST: /data
      REPLACE_ENV_DURING_SYNC: "true"
    ports:
      - "25573:25565"  # Direct access for Survival+
    volumes:
      - survivalplus_data:/data                # Persistent data (JAR, worlds, userdata)
      - ./survival_plus/config:/config:ro      # Configs from Git (read-only)
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles: ["debug"]


  limbo:
    build: ./limbo
    container_name: minecraft_limbo
    restart: unless-stopped
    expose:
      - "25578"
    volumes:
      - ./limbo:/server
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 100M
    profiles: ["debug"]
  survival:
    image: itzg/minecraft-server
    container_name: minecraft_survival
    restart: unless-stopped
    environment:
      TYPE: PAPER
      VERSION: 1.21.1
      MEMORY: ${SURVIVAL_MEMORY:-10G}
      EULA: "TRUE"
      ONLINE_MODE: "FALSE"
      SERVER_PORT: 25565
      USE_AIKAR_FLAGS: "TRUE"
      # Config sync settings
      SYNC_SKIP_NEWER_IN_DESTINATION: "true"
      COPY_CONFIG_DEST: /data
      REPLACE_ENV_DURING_SYNC: "true"
    ports:
      - "25571:25565"
    volumes:
      - survival_data:/data                    # Persistent data (JAR, worlds, userdata)
      - ./survival/config:/config:ro           # Configs from Git (read-only)
    networks:
      - minecraft_network
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles: ["debug"]

## WEBPACK SECTION

  backend:
    build: ./backend
    container_name: agicraft_backend
    restart: unless-stopped
    expose:
      - "3000"  # Internal port (accessible via Caddy)
    volumes:
      - ./backend/src:/app/src
    networks:
      - minecraft_network
      - nettyan_ssl
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-minecraft_server}
      POSTGRES_USER: ${POSTGRES_USER:-mcserver}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-StrongPass123!}
      JWT_SECRET: ${JWT_SECRET:-change_this_secret_key}
      PORT: 3000
      NODE_ENV: ${NODE_ENV:-production}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      YOOKASSA_RETURN_URL: ${YOOKASSA_RETURN_URL:-http://localhost/payment/success}
      YOOKASSA_WEBHOOK_URL: ${YOOKASSA_WEBHOOK_URL:-http://localhost/api/payment/webhook}
      MINECRAFT_HOST: airesearch
      MINECRAFT_PORT: 25570
      MINECRAFT_VERSION: 1.21.1
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build: ./frontend
    container_name: agicraft_frontend
    restart: unless-stopped
    expose:
      - "80"  # Internal port (accessible via nettyanweb Caddy)
    networks:
      - minecraft_network
      - nettyan_ssl
    depends_on:
      backend:
        condition: service_healthy
    environment:
      VITE_API_URL: ${VITE_API_URL:-/api}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # CRAFTY CONTROLLER - Web UI для управления серверами
  # https://hub.docker.com/r/arcadiatechnology/crafty-4
  # https://wiki.craftycontrol.com/en/4/Docker%20Setup%20Documentation
  # отключил из-за проблем с windows в crafty docker, говорят юзать portable

  ## CONTROL PANELS SECTION
  ## ADMIN PANELS AND MONITORING
  rcon-panel:
    image: itzg/rcon
    container_name: rcon_web_admin
    ports:
      - "4326:4326"
      - "4327:4327"
    environment:
      RWA_USERNAME: admin
      RWA_PASSWORD: ${RCON_PASSWORD:-StrongPass123!}
      RWA_ADMIN: "TRUE"
      # is referring to the service name 'mc' declared below
      RWA_RCON_HOST: airesearch
      RWA_RCON_PORT: 25580
      # needs to match the password configured for the container, see RCON_PASSWORD below
      RWA_RCON_PASSWORD: ${RCON_PASSWORD:-StrongPass123!}
      # Указываем, что будем управлять несколькими серверами через JSON конфиг
      RCON_MULTIPLE_SERVERS: "true"
      # RWA_ENV_CONFIG: "false" 
    volumes:
        # нельзя монтировать на /
    #   # Монтируем файл server.json с настройками серверов
      - rcon_panel_data:/opt/rcon-web-admin/db
    networks:
      - minecraft_network
      - nettyan_ssl
    depends_on:
      postgres:
        condition: service_healthy

  # Control MC docker images
  portainer:
      image: portainer/portainer-ce:latest
      container_name: portainer
      restart: unless-stopped
      security_opt:
        - no-new-privileges:true
      expose:
        - "9000"
      environment:
        # Задаем часовой пояс переменной, так как монтировать /etc/localtime на Windows нельзя
        - TZ=Europe/Moscow  # Поменяйте на свой, если нужно
      volumes:
        # На Docker Desktop for Windows это работает, так как он транслирует Windows Pipe в Linux Socket
        - /var/run/docker.sock:/var/run/docker.sock
        - portainer_data:/data
      networks:
        - minecraft_network
        - nettyan_ssl

networks:
  minecraft_network:
    driver: bridge
  nettyan_ssl:
    external: true
    name: nettyan_ssl

volumes:
  # PostgreSQL data
  postgres_data:
    name: nettyanmc_postgres_data
  portainer_data:
    name: nettyanmc_portainer_data
  rcon_panel_data:
    name: nettyanmc_rcon_panel_data
  # Minecraft server data volumes (persistent across rebuilds)
  # velocity_data removed - using custom build with local mount
  survival_data:
    name: nettyanmc_survival_data
  lobby_data:
    name: nettyanmc_lobby_data
  survivalplus_data:
    name: nettyanmc_survivalplus_data
