# Caddy конфигурация для AgiCraft
# Автоматические SSL сертификаты от Let's Encrypt

# ВАЖНО: Замените YOUR_DOMAIN на ваш реальный домен перед запуском!
# Примеры: nettyan.ru, agicraft.ru
{$DOMAIN:localhost} {
    # Автоматический HTTPS от Let's Encrypt
    # Caddy сам получит и обновит сертификаты

    # Email для уведомлений Let's Encrypt (обязательно!)
    # Для локального тестирования отключаем TLS
    tls internal

    # Логирование
    log {
        output file /var/log/caddy/access.log
        format json
    }

    # Главная страница и статика (Frontend)
    handle /* {
        reverse_proxy frontend:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Backend API
    handle /api/* {
        reverse_proxy backend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Health check endpoints
    handle /health {
        reverse_proxy backend:3000
    }

    # Статика фронтенда с кешированием
    handle /assets/* {
        reverse_proxy frontend:80 {
            header_down Cache-Control "public, max-age=31536000, immutable"
        }
    }
}

# Редирект с www на без www (опционально)
www.{$DOMAIN:localhost} {
    redir https://{$DOMAIN}{uri} permanent
}

# HTTP -> HTTPS редирект (автоматически делается Caddy)
# Но можно явно указать для порта 8080 если нужен
:8080 {
    redir https://{$DOMAIN}{uri} permanent
}
