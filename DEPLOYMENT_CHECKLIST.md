# Контрольный список развертывания NetTyanMC

Используйте этот чеклист для проверки готовности к развертыванию на production сервере.

---

## Перед развертыванием (локальная машина)

### Подготовка проекта

- [ ] Все изменения закоммичены в Git
- [ ] Код отправлен в GitHub репозиторий (`git push origin main`)
- [ ] Создан `.env` файл с production значениями
- [ ] `.env` НЕ закоммичен в Git (проверьте `.gitignore`)
- [ ] Все пароли в `.env` изменены с дефолтных значений
- [ ] YooKassa ключи получены и добавлены в `.env`
- [ ] Домен в `.env` заменен с YOUR_DOMAIN на реальный

### Проверка конфигураций

- [ ] `docker-compose.yml` проверен на корректность
- [ ] Backend Dockerfile проверен
- [ ] Frontend Dockerfile проверен
- [ ] Все плагины Minecraft скачаны (если не в Git)
- [ ] Конфигурации плагинов проверены

---

## Подготовка удаленного сервера

### Системные требования

- [ ] Ubuntu 20.04+ (или другой Linux) установлен
- [ ] Минимум 28GB RAM доступно (проверьте: `free -h`)
- [ ] Минимум 50GB свободного диска (проверьте: `df -h`)
- [ ] Процессор: 4+ ядер рекомендуется
- [ ] SSH доступ настроен
- [ ] У пользователя есть sudo права

### Установка ПО

- [ ] Docker 20.10+ установлен (проверьте: `docker --version`)
- [ ] Docker Compose 2.0+ установлен (проверьте: `docker compose version`)
- [ ] Git установлен (проверьте: `git --version`)
- [ ] Пользователь добавлен в группу docker: `sudo usermod -aG docker $USER`
- [ ] Перелогинились после добавления в группу docker

### Сеть и домен

- [ ] Домен зарегистрирован
- [ ] DNS A-запись настроена (домен → IP сервера)
- [ ] DNS проверен (проверьте: `dig your-domain.com`)
- [ ] Порты открыты в firewall:
  - [ ] 80/tcp (HTTP для Let's Encrypt)
  - [ ] 443/tcp (HTTPS)
  - [ ] 25565/tcp (Minecraft)
  - [ ] 25570/tcp (AI Research, опционально)

### Команды для настройки firewall (Ubuntu):

```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 25565/tcp
sudo ufw allow 25570/tcp
sudo ufw enable
sudo ufw status
```

---

## Настройка nettyanweb

### Развертывание nettyanweb

- [ ] nettyanweb клонирован в `/opt/nettyan/nettyanweb`
- [ ] nettyanweb Docker Compose запущен (`docker compose up -d`)
- [ ] Caddy контейнер работает (проверьте: `docker ps | grep caddy`)
- [ ] Сеть `nettyan_ssl` создана (проверьте: `docker network ls`)

### Настройка Caddyfile

- [ ] Создан backup Caddyfile: `cp Caddyfile Caddyfile.backup`
- [ ] В Caddyfile добавлена конфигурация для вашего домена:

```caddyfile
mc.your-domain.com {
    handle {
        reverse_proxy agicraft_frontend:80
    }
    handle /api/* {
        reverse_proxy agicraft_backend:3000
    }
}
```

- [ ] Caddyfile сохранен
- [ ] Caddy перезапущен: `docker compose restart caddy`
- [ ] Проверены логи Caddy: `docker compose logs -f caddy`
- [ ] Нет ошибок в логах Caddy
- [ ] SSL сертификат получен (должно быть в логах)

---

## Развертывание NetTyanMC

### Перенос проекта

- [ ] Создана директория: `sudo mkdir -p /opt/nettyan && sudo chown $USER:$USER /opt/nettyan`
- [ ] Репозиторий клонирован: `cd /opt/nettyan && git clone https://github.com/kragger-ra/NetTyanMC.git`
- [ ] Переход в директорию проекта: `cd NetTyanMC`

### Настройка .env

- [ ] `.env` файл создан на сервере (скопирован с локальной машины или создан из `.env.production`)
- [ ] Все переменные в `.env` проверены:
  - [ ] `POSTGRES_PASSWORD` - надежный пароль (16+ символов)
  - [ ] `JWT_SECRET` - случайная строка (32+ символа)
  - [ ] `RCON_PASSWORD` - надежный пароль (12+ символов)
  - [ ] `YOOKASSA_SHOP_ID` - реальный ID магазина
  - [ ] `YOOKASSA_SECRET_KEY` - реальный секретный ключ
  - [ ] `FRONTEND_URL` - ваш реальный домен с https://
  - [ ] `YOOKASSA_RETURN_URL` - ваш домен с правильным путем
  - [ ] `YOOKASSA_WEBHOOK_URL` - ваш домен с правильным путем
  - [ ] `*_MEMORY` - настроены под ваш сервер (28GB+ total)

### Запуск проекта

- [ ] Запущен Docker Compose: `docker compose up -d`
- [ ] Ожидание 2-5 минут для инициализации
- [ ] Проверен статус контейнеров: `docker compose ps`
- [ ] Все контейнеры в статусе "Up" или "Up (healthy)"
- [ ] Нет ошибок в логах: `docker compose logs --tail=50 | grep -i error`

---

## Проверка работоспособности

### Базовая проверка

- [ ] Backend API работает: `curl http://localhost:3000/health` → `{"status":"ok"}`
- [ ] PostgreSQL здоров: `docker compose ps postgres` → "Up (healthy)"
- [ ] Frontend собран и запущен
- [ ] Velocity запущен и готов принимать соединения
- [ ] Paper серверы (Lobby, Survival, AI Research) запущены

### Проверка веб-сайта

- [ ] Сайт открывается: `https://your-domain.com`
- [ ] HTTPS работает (зеленый замок в браузере)
- [ ] Нет ошибок сертификата
- [ ] Главная страница загружается
- [ ] Страница регистрации открывается
- [ ] Можно создать аккаунт
- [ ] Можно войти в личный кабинет
- [ ] API запросы работают (проверьте в DevTools Network)

### Проверка Minecraft сервера

- [ ] Подключение к серверу работает: `your-domain.com:25565`
- [ ] Попадание в Lobby происходит
- [ ] AuthMe работает (если настроена)
- [ ] Переход между серверами работает (Lobby → Survival)
- [ ] Нет ошибок в консоли серверов

### Проверка базы данных

- [ ] Подключение к PostgreSQL работает: `docker exec -it minecraft_postgres psql -U mcserver -d minecraft_server`
- [ ] Все таблицы созданы: `\dt`
- [ ] Таблицы LuckPerms присутствуют
- [ ] Таблицы веб-приложения присутствуют (web_users, web_donations, etc)

### Проверка логов

- [ ] Проверены логи всех сервисов: `docker compose logs --tail=100`
- [ ] Нет критических ошибок в логах
- [ ] PostgreSQL успешно инициализирован
- [ ] Backend подключился к PostgreSQL
- [ ] Frontend успешно собрался
- [ ] Velocity подключился к Paper серверам
- [ ] Paper серверы загрузили плагины

---

## Настройка Minecraft серверов

### LuckPerms (система прав)

См. [LUCKPERMS_SETUP.md](LUCKPERMS_SETUP.md)

- [ ] Создана группа `new`
- [ ] Создана группа `helper`
- [ ] Создана группа `vip`
- [ ] Создана группа `ai_research`
- [ ] Создана группа `ai_person`
- [ ] Создана группа `netfather` (админ)
- [ ] Настроены веса групп
- [ ] Настроены права для каждой группы
- [ ] Назначена дефолтная группа: `/lp group new parent set default`
- [ ] Себе выдан админ: `/lp user YOUR_NICKNAME parent add netfather`

### Lobby сервер

См. [LOBBY_SETUP.md](LOBBY_SETUP.md)

- [ ] Создана платформа spawn (20x20 на Y=100)
- [ ] Настроена WorldGuard защита
- [ ] Созданы NPC для телепортации
- [ ] Настроены голограммы
- [ ] AuthMe настроена (если используется)
- [ ] Тестовый игрок может зайти и зарегистрироваться

### Survival сервер

- [ ] Spawn point установлен
- [ ] WorldGuard защита spawn настроена
- [ ] PlayerPoints работает
- [ ] ShopGUIPlus настроен (магазин рангов)
- [ ] Можно купить ранг за AgiCoins

### AI Research сервер

См. [AI_RESEARCH_SETUP.md](AI_RESEARCH_SETUP.md)

- [ ] Spawn в Нижнем мире защищен (50x50)
- [ ] End - полная анархия (без защиты)
- [ ] Права настроены для ai_research / ai_person
- [ ] AI боты могут подключаться напрямую на порт 25570

---

## Интеграция и тестирование

### YooKassa (донат система)

- [ ] Shop ID и Secret Key настроены в `.env`
- [ ] Webhook URL правильный
- [ ] Return URL правильный
- [ ] Тестовая покупка проходит успешно
- [ ] Webhook получен после оплаты
- [ ] AgiCoins зачисляются на баланс
- [ ] Ранги выдаются автоматически через RCON

### RCON

- [ ] RCON настроен на всех Paper серверах
- [ ] Backend может подключиться по RCON
- [ ] Команды выполняются успешно
- [ ] Тестовая выдача AgiCoins работает: `/points give Player 100`

### Тестовые сценарии

- [ ] **Сценарий 1:** Регистрация на сайте → Вход → Проверка баланса
- [ ] **Сценарий 2:** Покупка AgiCoins → Проверка начисления
- [ ] **Сценарий 3:** Покупка ранга за рубли → Проверка выдачи в игре
- [ ] **Сценарий 4:** Покупка ранга за AgiCoins в игре → Проверка работы
- [ ] **Сценарий 5:** Подключение к Minecraft → Регистрация → Переход на Survival
- [ ] **Сценарий 6:** AI бот подключается к AI Research серверу

---

## Безопасность

### Пароли и секреты

- [ ] Все дефолтные пароли изменены
- [ ] `.env` не закоммичен в Git
- [ ] `.env` имеет права 600: `chmod 600 .env`
- [ ] Пароли соответствуют требованиям:
  - [ ] POSTGRES_PASSWORD: 16+ символов
  - [ ] JWT_SECRET: 32+ символа
  - [ ] RCON_PASSWORD: 12+ символов
- [ ] Пароли сохранены в надежном месте (менеджер паролей)

### Firewall

- [ ] Firewall включен: `sudo ufw enable`
- [ ] Открыты только необходимые порты (80, 443, 25565, 25570)
- [ ] SSH порт защищен (опционально изменен с 22)
- [ ] Включен rate limiting для SSH (опционально)

### Backup

- [ ] Настроен регулярный backup PostgreSQL
- [ ] Настроен backup миров (опционально)
- [ ] Протестировано восстановление из backup

---

## Мониторинг и поддержка

### Мониторинг

- [ ] Настроен мониторинг использования ресурсов: `docker stats`
- [ ] Настроен мониторинг дискового пространства: `df -h`
- [ ] Настроены алерты на критические ошибки (опционально)
- [ ] Добавлены закладки для быстрого доступа:
  - [ ] Веб-сайт: `https://your-domain.com`
  - [ ] Grafana/Prometheus (если настроены)

### Документация

- [ ] Прочитана документация: [PRODUCTION_DEPLOYMENT.md](PRODUCTION_DEPLOYMENT.md)
- [ ] Сохранены команды для частого использования
- [ ] Известны все пути к логам
- [ ] Известны команды для перезапуска сервисов

### Регулярные задачи

- [ ] Создан календарь для:
  - [ ] Ежедневной проверки логов
  - [ ] Еженедельного backup
  - [ ] Ежемесячного обновления Docker образов
  - [ ] Ежемесячного обновления плагинов

---

## Финальная проверка

### Перед объявлением о запуске

- [ ] Все критичные баги исправлены
- [ ] Тестовые сценарии пройдены успешно
- [ ] Performance тестирование проведено (нагрузка на сервер)
- [ ] Все системы работают стабильно минимум 24 часа
- [ ] Backup настроен и протестирован
- [ ] Известны процедуры rollback на случай проблем

### Коммуникация

- [ ] Подготовлено объявление о запуске
- [ ] Созданы каналы поддержки (Discord, Telegram, etc)
- [ ] Подготовлены FAQ и гайды для игроков
- [ ] Известны контакты для экстренной связи

---

## После запуска

### Первые 24 часа

- [ ] Активный мониторинг всех систем
- [ ] Быстрое реагирование на баги
- [ ] Сбор отзывов от первых игроков
- [ ] Мониторинг использования ресурсов

### Первая неделя

- [ ] Ежедневный мониторинг
- [ ] Исправление найденных багов
- [ ] Оптимизация производительности
- [ ] Backup протестирован и работает

---

## Полезные команды

```bash
# Перейти в директорию проекта
cd /opt/nettyan/NetTyanMC

# Проверить статус
docker compose ps

# Просмотреть логи
docker compose logs -f

# Перезапустить все
docker compose restart

# Перезапустить конкретный сервис
docker compose restart backend

# Остановить все
docker compose down

# Запустить все
docker compose up -d

# Подключиться к консоли Minecraft
docker attach minecraft_velocity
# Отключиться: Ctrl+P, затем Ctrl+Q

# Backup базы данных
docker exec minecraft_postgres pg_dump -U mcserver minecraft_server > backup_$(date +%Y%m%d).sql

# Проверить использование ресурсов
docker stats

# Проверить диск
df -h

# Проверить память
free -h
```

---

## Контакты для помощи

- GitHub Issues: https://github.com/kragger-ra/NetTyanMC/issues
- Документация проекта: `/opt/nettyan/NetTyanMC/README.md`
- Discord сервер: (добавьте ваш)

---

**Готово? Запускайте сервер и удачи!**
