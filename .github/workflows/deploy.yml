name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Позволяет запустить вручную из интерфейса GitHub

jobs:
  deploy:
    name: Deploy to Server
    runs-on: self-hosted
    if: "github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy]')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        shell: powershell
        run: |
          Write-Host "======================================" -ForegroundColor Cyan
          Write-Host "Starting deployment..." -ForegroundColor Cyan
          Write-Host "======================================" -ForegroundColor Cyan

          Write-Host "Code checked out to: $(Get-Location)"
          Write-Host "Current commit: $(git log --oneline -1)"

          # Copy files to production directory (preserve existing data volumes)
          Write-Host "Syncing files to D:\Repos\NettyanMC..."
          Copy-Item -Path ".\docker-compose.yml" -Destination "D:\Repos\NettyanMC\" -Force
          Copy-Item -Path ".\.github" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\velocity" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\survival" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\lobby" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\limbo" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\ai_research" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\backend" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\frontend" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\survival_plus" -Destination "D:\Repos\NettyanMC\" -Recurse -Force

          # Switch to production directory
          Set-Location D:\Repos\NettyanMC
          Write-Host "Working in: $(Get-Location)"

          Write-Host "--------------------------------------" -ForegroundColor Yellow
          Write-Host "Deploying services (files already updated via git on server)..."
          Write-Host "Rebuilding frontend and backend without cache..."
          docker compose build --no-cache frontend backend
          Write-Host "Rebuilding other services with cache..."
          docker compose build
          Write-Host "Restarting all services..."
          docker compose up -d --remove-orphans
          Write-Host "--------------------------------------" -ForegroundColor Yellow

          Write-Host "Checking service status..."
          docker compose ps

          Write-Host "======================================" -ForegroundColor Cyan
          Write-Host "Deployment completed successfully!" -ForegroundColor Green
          Write-Host "======================================" -ForegroundColor Cyan

      - name: Notify on failure
        if: failure()
        shell: powershell
        run: |
          Write-Host "❌ Deployment failed! Check the logs above for details."
