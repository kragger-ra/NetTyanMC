name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Позволяет запустить вручную из интерфейса GitHub

jobs:
  deploy:
    name: Deploy to Server
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env from secrets
        shell: powershell
        run: |
          "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" | Out-File -FilePath .env -Encoding utf8
          "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "JWT_SECRET=${{ secrets.JWT_SECRET }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "RCON_PASSWORD=${{ secrets.RCON_PASSWORD }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "YOOKASSA_SHOP_ID=${{ secrets.YOOKASSA_SHOP_ID }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "YOOKASSA_SECRET_KEY=${{ secrets.YOOKASSA_SECRET_KEY }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "YOOKASSA_RETURN_URL=${{ secrets.YOOKASSA_RETURN_URL }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "YOOKASSA_WEBHOOK_URL=${{ secrets.YOOKASSA_WEBHOOK_URL }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "VITE_API_URL=${{ secrets.VITE_API_URL }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "NODE_ENV=production" | Out-File -FilePath .env -Encoding utf8 -Append
          "SURVIVAL_MEMORY=10G" | Out-File -FilePath .env -Encoding utf8 -Append
          "AI_RESEARCH_MEMORY=10G" | Out-File -FilePath .env -Encoding utf8 -Append
          "LOBBY_MEMORY=2G" | Out-File -FilePath .env -Encoding utf8 -Append
          "VELOCITY_MEMORY=1G" | Out-File -FilePath .env -Encoding utf8 -Append
          "TZ=Europe/Moscow" | Out-File -FilePath .env -Encoding utf8 -Append

      - name: Deploy to server
        shell: powershell
        run: |
          Write-Host "======================================" -ForegroundColor Cyan
          Write-Host "Starting deployment..." -ForegroundColor Cyan
          Write-Host "======================================" -ForegroundColor Cyan

          cd N:\Minecraftserver

          Write-Host "Current commit:"
          git log -1 --oneline

          $hasChanges = git diff-index --quiet HEAD --
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Stashing local changes..."
            git stash
          }

          Write-Host "Pulling latest changes..."
          git fetch origin
          git pull origin main

          Write-Host "New commit:"
          git log -1 --oneline

          Write-Host "--------------------------------------" -ForegroundColor Yellow
          Write-Host "Changed files in this update:"
          $changedFiles = git diff --name-only HEAD@{1} HEAD 2>$null
          if ($changedFiles) {
            Write-Host $changedFiles
          } else {
            Write-Host "No previous commit to compare"
          }
          Write-Host "--------------------------------------" -ForegroundColor Yellow

          $restartAll = $false
          $restartServices = @()

          if ($changedFiles -match "^backend/") {
            Write-Host "Backend changes detected"
            $restartServices += "backend"
          }

          if ($changedFiles -match "^frontend/") {
            Write-Host "Frontend changes detected"
            $restartServices += "frontend"
          }

          if ($changedFiles -match "(survival|lobby|ai_research|velocity)/config/") {
            Write-Host "Minecraft config changes detected"
            $restartServices += "survival", "lobby", "airesearch", "velocity"
          }

          if ($changedFiles -match "docker-compose.yml") {
            Write-Host "docker-compose.yml changed - full restart required"
            $restartAll = $true
          }

          Write-Host "--------------------------------------" -ForegroundColor Yellow
          if ($restartAll) {
            Write-Host "Restarting all services..."
            docker compose down
            docker compose up -d
          } elseif ($restartServices.Count -gt 0) {
            Write-Host "Restarting services: $($restartServices -join ', ')"

            if ($restartServices -contains "backend" -or $restartServices -contains "frontend") {
              Write-Host "Rebuilding changed services..."
              docker compose build $restartServices
            }

            docker compose up -d $restartServices
          } else {
            Write-Host "No service restart required"
          }
          Write-Host "--------------------------------------" -ForegroundColor Yellow

          Write-Host "Checking service status..."
          docker compose ps

          Write-Host "--------------------------------------" -ForegroundColor Yellow
          Write-Host "Checking for errors in logs..."
          $logs = docker compose logs --tail=20 2>&1 | Select-String -Pattern "error|exception|fatal" -CaseSensitive:$false
          if ($logs) {
            Write-Host "Errors found in logs - please check manually" -ForegroundColor Red
            $logs
          } else {
            Write-Host "No critical errors in recent logs" -ForegroundColor Green
          }

          Write-Host "======================================" -ForegroundColor Cyan
          Write-Host "Deployment completed successfully!" -ForegroundColor Green
          Write-Host "======================================" -ForegroundColor Cyan

      - name: Notify on failure
        if: failure()
        shell: powershell
        run: |
          Write-Host "❌ Deployment failed! Check the logs above for details."
