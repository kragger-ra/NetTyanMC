name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Позволяет запустить вручную из интерфейса GitHub

jobs:
  deploy:
    name: Deploy to Server
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        shell: powershell
        run: |
          Write-Host "======================================"
          Write-Host "Starting deployment..."
          Write-Host "======================================"

          # Переходим в директорию проекта
          cd N:\Minecraftserver

          # Проверяем текущий коммит
          Write-Host "Current commit:"
          git log -1 --oneline

          # Делаем stash если есть локальные изменения
          $hasChanges = git diff-index --quiet HEAD --
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Stashing local changes..."
            git stash
          }

          # Получаем последние изменения
          Write-Host "Pulling latest changes..."
          git fetch origin
          git pull origin main

          Write-Host "New commit:"
          git log -1 --oneline

          # Проверяем какие файлы изменились
          Write-Host "======================================"
          Write-Host "Changed files in this update:"
          $changedFiles = git diff --name-only HEAD@{1} HEAD 2>$null
          if ($changedFiles) {
            Write-Host $changedFiles
          } else {
            Write-Host "No previous commit to compare"
          }
          Write-Host "======================================"

          # Определяем что нужно перезапустить
          $restartAll = $false
          $restartServices = @()

          # Проверяем изменения в backend
          if ($changedFiles -match "^backend/") {
            Write-Host "Backend changes detected"
            $restartServices += "backend"
          }

          # Проверяем изменения в frontend
          if ($changedFiles -match "^frontend/") {
            Write-Host "Frontend changes detected"
            $restartServices += "frontend"
          }

          # Проверяем изменения в конфигах Minecraft
          if ($changedFiles -match "(survival|lobby|ai_research|velocity)/config/") {
            Write-Host "Minecraft config changes detected"
            $restartServices += "survival", "lobby", "airesearch", "velocity"
          }

          # Проверяем изменения в docker-compose.yml
          if ($changedFiles -match "docker-compose.yml") {
            Write-Host "docker-compose.yml changed - full restart required"
            $restartAll = $true
          }

          # Перезапускаем сервисы
          Write-Host "======================================"
          if ($restartAll) {
            Write-Host "Restarting all services..."
            docker compose down
            docker compose up -d
          } elseif ($restartServices.Count -gt 0) {
            Write-Host "Restarting services: $($restartServices -join ', ')"

            # Пересборка если нужно
            if ($restartServices -contains "backend" -or $restartServices -contains "frontend") {
              Write-Host "Rebuilding changed services..."
              docker compose build $restartServices
            }

            docker compose up -d $restartServices
          } else {
            Write-Host "No service restart required"
          }
          Write-Host "======================================"

          # Проверяем статус
          Write-Host "Checking service status..."
          docker compose ps

          # Проверяем логи на ошибки
          Write-Host "======================================"
          Write-Host "Checking for errors in logs..."
          $logs = docker compose logs --tail=20 2>&1 | Select-String -Pattern "error|exception|fatal" -CaseSensitive:$false
          if ($logs) {
            Write-Host "⚠️  Errors found in logs - please check manually"
            $logs
          } else {
            Write-Host "✓ No critical errors in recent logs"
          }

          Write-Host "======================================"
          Write-Host "Deployment completed successfully!"
          Write-Host "======================================"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed! Check the logs above for details."
