name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Позволяет запустить вручную из интерфейса GitHub

jobs:
  deploy:
    name: Deploy to Server
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        shell: powershell
        run: |
          Write-Host "======================================" -ForegroundColor Cyan
          Write-Host "Starting deployment..." -ForegroundColor Cyan
          Write-Host "======================================" -ForegroundColor Cyan

          Write-Host "Code checked out to: $(Get-Location)"
          Write-Host "Current commit: $(git log --oneline -1)"

          # Copy files to production directory (preserve existing data volumes)
          Write-Host "Syncing files to D:\Repos\NettyanMC..."
          Copy-Item -Path ".\docker-compose.yml" -Destination "D:\Repos\NettyanMC\" -Force
          Copy-Item -Path ".\.github" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\velocity" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\survival" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\lobby" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\ai_research" -Destination "D:\Repos\NettyanMC\" -Recurse -Force
          Copy-Item -Path ".\backend" -Destination "D:\Repos\NettyanMC\" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path ".\frontend" -Destination "D:\Repos\NettyanMC\" -Recurse -Force -ErrorAction SilentlyContinue

          # Switch to production directory
          Set-Location D:\Repos\NettyanMC
          Write-Host "Working in: $(Get-Location)"

          # Create .env from secrets
          Write-Host "Creating .env file..."
          "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" | Out-File -FilePath .env -Encoding utf8
          "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "JWT_SECRET=${{ secrets.JWT_SECRET }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "RCON_PASSWORD=${{ secrets.RCON_PASSWORD }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "YOOKASSA_SHOP_ID=${{ secrets.YOOKASSA_SHOP_ID }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "YOOKASSA_SECRET_KEY=${{ secrets.YOOKASSA_SECRET_KEY }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "YOOKASSA_RETURN_URL=${{ secrets.YOOKASSA_RETURN_URL }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "YOOKASSA_WEBHOOK_URL=${{ secrets.YOOKASSA_WEBHOOK_URL }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "VITE_API_URL=${{ secrets.VITE_API_URL }}" | Out-File -FilePath .env -Encoding utf8 -Append
          "NODE_ENV=production" | Out-File -FilePath .env -Encoding utf8 -Append
          "SURVIVAL_MEMORY=10G" | Out-File -FilePath .env -Encoding utf8 -Append
          "AI_RESEARCH_MEMORY=10G" | Out-File -FilePath .env -Encoding utf8 -Append
          "LOBBY_MEMORY=2G" | Out-File -FilePath .env -Encoding utf8 -Append
          "VELOCITY_MEMORY=1G" | Out-File -FilePath .env -Encoding utf8 -Append
          "TZ=Europe/Moscow" | Out-File -FilePath .env -Encoding utf8 -Append

          Write-Host "--------------------------------------" -ForegroundColor Yellow
          Write-Host "Deploying services (files already updated via git on server)..."
          Write-Host "Rebuilding and restarting all services..."
          docker compose build
          docker compose up -d --remove-orphans
          Write-Host "--------------------------------------" -ForegroundColor Yellow

          Write-Host "Checking service status..."
          docker compose ps

          Write-Host "======================================" -ForegroundColor Cyan
          Write-Host "Deployment completed successfully!" -ForegroundColor Green
          Write-Host "======================================" -ForegroundColor Cyan

      - name: Notify on failure
        if: failure()
        shell: powershell
        run: |
          Write-Host "❌ Deployment failed! Check the logs above for details."
